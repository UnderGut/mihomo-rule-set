name: Generate mihomo Rules

on:
  schedule:
    # –ó–∞–ø—É—Å–∫–∞—Ç—å –≤ 2:00 UTC –∫–∞–∂–¥—ã–π –¥–µ–Ω—å (5 —É—Ç—Ä–∞ –ø–æ –ú–°–ö)
    - cron: '0 2 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download and install Mihomo
        run: |
          echo "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–µ–º .deb –ø–∞–∫–µ—Ç Mihomo..."
          curl -L -o mihomo.deb \
            https://github.com/MetaCubeX/mihomo/releases/download/v1.19.9/mihomo-linux-amd64-v1.19.9.deb
        
          echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
          sudo apt-get update
          sudo apt-get install -y ./mihomo.deb

      # --- –ö–õ–Æ–ß–ï–í–û–ô –®–ê–ì –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –û–®–ò–ë–ö–ò ---
      # –≠—Ç–æ—Ç —à–∞–≥ —É–¥–∞–ª—è–µ—Ç —Å–∏–º–≤–æ–ª—ã \r (CR) –∏ –¥–µ–ª–∞–µ—Ç —Å–∫—Ä–∏–ø—Ç –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º.
      - name: Fix line endings and make script executable
        run: |
          sed -i 's/\r$//' ./build.sh
          chmod +x ./build.sh

      - name: Run build script
        # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–∫—Ä–∏–ø—Ç –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ –º—ã —Å–¥–µ–ª–∞–ª–∏ –µ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
        run: ./build.sh

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Auto-update mihomo rule sets"
          file_pattern: dist/*.mrs
